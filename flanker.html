<!DOCTYPE html>
<html>
  <head>
    <title>Flanker</title>
    <script src="./dist/jspsych.js"></script>
    <script src="./dist/plugin-html-keyboard-response.js"></script>
    <script src="./dist/plugin-html-button-response.js"></script>
    <script src="./dist/plugin-fullscreen.js"></script>
    <script src="./config/variables.js"></script>
    <script src="./config/jp.js"></script> <!-- Use en.js for English instructions, jp.js for Japanese -->
    <link href="./dist/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="./style/style.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    const jsPsych = initJsPsych({
      on_finish: function() {
         // 実験データをCSV形式で取得（correctなどの情報を含む）
    const csvData = jsPsych.data.get().csv(); // データをCSV形式で取得

    // データをサーバに送信
    sendDataToServer(csvData);
      }
    });

    let timeline = [];

    
// ID入力タスクを最後に移動
let participantId = null; // Global variable to store the ID

const id_input = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h1>実験ID入力</h1>
    <p>実験を終える前に、以下の入力欄に半角数字でIDを入力してください。</p>
    <input type="text" id="participant_id" placeholder="IDを入力" style="font-size: 18px; padding: 5px; width: 50%; margin-bottom: 10px;">
    <p id="error_message" style="color: red; display: none;">IDは半角数字で入力してください。</p>
  `,
  choices: ["送信"],
  on_finish: function (data) {
    const inputValue = jsPsych.getDisplayElement().querySelector("#participant_id")?.value.trim();
    if (idInput) {
        const inputValue = idInput.value.trim();
        console.log("Input value before validation:", inputValue);

        if (inputValue && /^[0-9]+$/.test(inputValue)) {
          participantId = inputValue; // IDをグローバル変数にキャッシュ
          data.participant_id = inputValue; // jsPsychのデータに保存
          console.log("Valid ID entered:", inputValue);
        } else {
          data.participant_id = null; // 無効な場合
          console.error("Invalid or missing ID entered.");
        }
      } else {
        console.error("Input element not found in DOM!");
        data.participant_id = null; // DOM要素が見つからない場合
      }
  },
};

// Later in the experiment, you can use `participantId` where needed


// Adding the display of cached ID to the timeline
timeline.push(participantId);

    const enter_fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: true,
      message: lang.fullscreen,
      button_label: lang.utils.next
    }

    const welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: lang.welcome,
      choices: [lang.utils.next]
    };

    const instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: lang.instructions.flanker,
      choices: [lang.utils.next]
    };

    const beginTask = {
      type: jsPsychHtmlButtonResponse,
      stimulus: lang.begin,
      choices: [lang.utils.next],
      post_trial_gap: interstimuli_interval.instructions
    };
    timeline.push(enter_fullscreen, welcome, instructions, beginTask);
    
　　const test_stimuli = [];
for (let i = 0; i < 10; i++) {
  test_stimuli.push(generateFlankerStimulus());  // 10問分のフランカー刺激を生成
}

// generateFlankerStimulus関数の定義
function generateFlankerStimulus() {
  // 5つの記号（＜＞）をランダムに生成
  const symbols = ['＜', '＞'];
  let stimulus = [];
  
  // 5つの記号をランダムに並べる
  for (let i = 0; i < 5; i++) {
    stimulus.push(symbols[Math.floor(Math.random() * symbols.length)]);
  }

  // 真ん中の記号を基準に正解を決める
  const correct_response = stimulus[2] === '＞' ? 'left' : 'right';
  
  return {
    stimulus: `<span class="text">${stimulus.join('')}</span>`,
    correct_response: correct_response
  };
}

console.log(test_stimuli);

const fixation = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<div class="text">+</div>',
  choices: "NO_KEYS",
  trial_duration: 1000,
  data: {
    task: 'fixation'
  }
};

const test = {
  type: jsPsychHtmlButtonResponse,
  stimulus: jsPsych.timelineVariable('stimulus'),  // ランダムに生成された刺激を表示
  choices: ['左', '右'],  // ユーザーが選択するボタン
  button_html: `
    <button style="position: absolute; left: 15%; bottom: 15%; font-size: 60px;">左</button>
    <button style="position: absolute; right: 15%; bottom: 15%; font-size: 60px;">右</button>
  `,  // 左右のボタンを画面下に配置
  data: {
    task: 'response',
    correct_response: jsPsych.timelineVariable('correct_response')  // 正解のボタンを取得
  },
  on_finish: function(data) {
    // ユーザーの反応が正しいかをチェックし、データに記録
    data.correct = (data.response === data.correct_response);
  }
};

// flanker課題をタイムラインに追加
const flanker = {
  timeline: [fixation, test],
  timeline_variables: test_stimuli,  // 10問の刺激を使用
  randomize_order: true,  // 刺激の順番をランダム化
  repetitions: 1  // 各刺激は1回のみ表示
};

timeline.push(flanker);

    const end = {
      type: jsPsychHtmlButtonResponse,
      stimulus: lang.end,
      choices: [lang.utils.finish]
    };

    const exit_fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: false,
      delay_after: 0
    }
    timeline.push(end, exit_fullscreen);

   const debrief_block = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const trials = jsPsych.data.get().filter({task: 'response'});
        const correct_trials = trials.filter({correct: true});
        const accuracy = Math.round(correct_trials.count() / trials.count() * 100);
        // const rt = Math.round(correct_trials.select('rt').mean());

        return feedback(accuracy);
      }
    };
    timeline.push(debrief_block);

// 実験を実行
jsPsych.run(timeline);

    // データをサーバに送信する関数
function sendDataToServer(csvData) {
  const participantId = jsPsych.data.get().last(1).values()[0].participant_id || "no_id"; // 最後の試行からIDを取得、IDがない場合は"no_id"とする
  const now = new Date();
  const timestamp = `${now.getFullYear()}_${(now.getMonth() + 1).toString().padStart(2, '0')}_${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}_${now.getMinutes().toString().padStart(2, '0')}_${now.getSeconds().toString().padStart(2, '0')}`;

  const filename = `flanker1_${participantId}_${timestamp}.csv`; // ファイル名にIDとタイムスタンプを追加

  fetch("https://pipe.jspsych.org/api/data/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Accept: "*/*",
    },
    body: JSON.stringify({
      experimentID: "nTfNs3BeCPOK",  // jsPsych Pipeの実験ID
      filename: filename,            // ユニークなファイル名
      data: csvData                  // 実験データをCSV形式で送信
    }),
  })
  .then(response => {
    if (response.ok) {
      console.log('データが正常に保存されました');
    } else {
      console.error('データの保存中にエラーが発生しました');
    }
  })
  .catch(error => {
    console.error('通信エラーが発生しました:', error);
  });
}

  </script>
</html>
